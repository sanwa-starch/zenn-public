---
title: "MS SQL Server ã® Cloud SQL for SQL Server ç§»è¡Œã§ backpac ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ›´æ–°ã—ãŸã¨ãã®ãƒ¡ãƒ¢"
emoji: "ğŸ”¥"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [sqlserver, gcp]
published: false
---

ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã® MS SQL Server ã‚’ Google Cloud SQL for SQL Server ã«ç§»è¡Œã™ã‚‹ã«ã‚ãŸã‚Šã€å°‘ã—æ‰‹é–“å–ã‚Šã¾ã—ãŸã®ã§å½“ç¤¾ã§è¡Œã£ãŸ bacpac ã®æ“ä½œã‚’å‚™å¿˜éŒ²ã¨ã—ã¦å…±æœ‰ã„ãŸã—ã¾ã™ã€‚


# ç§»è¡Œå‰ã®ã‚µãƒ¼ãƒç’°å¢ƒ
- Windows Server 2012
- MS SQL Server 2012 Standard Edition
- FileStream åˆ©ç”¨
- LinkServer åˆ©ç”¨ (ãƒ—ãƒ­ãƒã‚¤ãƒ€ã¯ SQL Server, Oracle ãªã©æ··åœ¨)
- éåŒ…å«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹

# ç§»è¡Œå¾Œã®ç’°å¢ƒ
- Cloud SQL for SQL Server 2022
  - SQL Server Provider ã® LinkServer åˆ©ç”¨
  - ç…§åˆé †åºå¤‰æ›´
  - éåŒ…å«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
  - ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆ©ç”¨
- MS SQL Server 2022 Standard Edition
  - FileStream åˆ©ç”¨
  - Oracle Provider ã® LinkServer åˆ©ç”¨
  - éåŒ…å«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
  - ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆ©ç”¨

# ã¯ã—ãŒã
å½“ç¤¾ã§ã¯å¾“æ¥ã‚ˆã‚Šæ¥­å‹™ãƒ‡ãƒ¼ã‚¿è“„ç©ã« MS SQL Server ã‚’åˆ©ç”¨ã—ã¦ã„ã¾ã—ãŸãŒã€é•·å¹´åˆ©ç”¨ã—ã¦ã„ã‚‹ã†ã¡ã«æ¥­å‹™ãƒ‡ãƒ¼ã‚¿è“„ç©ã®ã¿ãªã‚‰ãšã€ã‚·ã‚¹ãƒ†ãƒ é–“é€£æºãƒ‡ãƒ¼ã‚¿ã‚„ä»–ã‚·ã‚¹ãƒ†ãƒ ãƒ‡ãƒ¼ã‚¿ã‚’ä¿æŒã™ã‚‹ã‚ˆã†ã«ãªã‚Šã€ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é¢ã‚„å¯ç”¨æ€§ã®é‡è¦æ€§ãŒå¢—ã™ã¨ã¨ã‚‚ã«ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹é¢ã§ã®å•é¡ŒãŒé¡•è‘—ã«ãªã£ã¦ããŸãŸã‚ã€ä»Šå¾Œã®æ‹¡å¼µæ€§ã¨ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ€§ã‚’è€ƒãˆã¦ Cloud SQL for SQL Server ã«ç§»è¡Œã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚
Cloud SQL for SQL Server ã¯ Linux ãƒ™ãƒ¼ã‚¹ã§ã‚ã‚Šã€æœ¬ç¨¿åŸ·ç­†æ™‚ã¯ FileStream ã¨ Oracle Provider ã§ã® LinkServer ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã®ã§ã€ãã®æ©Ÿèƒ½ãŒå¿…è¦ãªã‚·ã‚¹ãƒ†ãƒ éƒ¨åˆ†ã¯ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã§æ®‹ã—ã€ç§»è¡Œå¯èƒ½ãªã‚·ã‚¹ãƒ†ãƒ éƒ¨åˆ†ã®ã¿ã‚’ç§»è¡Œã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚ã‚³ã‚¹ãƒˆã¯æ›ã‹ã‚Šã¾ã™ãŒã€å°‘äººæ•°ã§å®‰å®šç¨¼åƒã‚’ç¶­æŒã—ã¦ã„ããŸã‚ã«ã¯å°†æ¥çš„ã«ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚’å°‘ãªãã™ã‚‹ç’°å¢ƒã«æŒã£ã¦ã„ãã“ã¨ãŒãƒ™ã‚¿ãƒ¼ã¨åˆ¤æ–­ã—ã¾ã—ãŸã€‚
ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ â†’ ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã®ç§»è¡Œã¯å®¹æ˜“ã§ã™ãŒã€ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ â†’ Cloud SQL ã®ç§»è¡Œæ¤œè¨¼ã«æ‰‹é–“å–ã‚Šã¾ã—ãŸã®ã§ã€ã“ã“ã§ãã®æ‰‹é †ã«ã¤ã„ã¦ç°¡å˜ã«æ®‹ã—ã¦ãŠãã¾ã™ã€‚

# æ‰‹é †
### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆ†å‰²
ç§»è¡Œå‰ã¯ä¸€ã¤ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«è¤‡æ•°ã®ã‚·ã‚¹ãƒ†ãƒ ãŒæ··åœ¨ã—ã¦ã„ã‚‹ã‚ˆã†ãªå½¢ã§ã™ã®ã§ã€ã‚ªãƒ³ãƒ—ãƒ¬ãƒŸã‚¹ã«æ®‹ã™ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¨ã€Cloud SQL ã«ç§»è¡Œã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã«åˆ†å‰²ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚
ã“ã‚Œã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ã‚‚ã¨ã«ã€åˆ¥åã§ 2 ã¤ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ³ã‚’ä½œæˆã—ã¦ã€ç‰‡æ–¹ã¯ã‚ªãƒ³ãƒ—ãƒ¬ã«æ®‹ã™ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä»¥å¤–ã‚’å‰Šé™¤ã—ã‚ªãƒ³ãƒ—ãƒ¬ç”¨ã€ã‚‚ã†ç‰‡æ–¹ã¯ Cloud SQL ã«ç§»è¡Œã™ã‚‹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆä»¥å¤–ã‚’å‰Šé™¤ã— Cloud SQL ç§»è¡Œç”¨ã¨ã—ã¦æ•´ç†ã—ã¾ã—ãŸã€‚(å‹•ä½œæ¤œè¨¼ãŒå¤§å¤‰ï¼)

### Cloud SQL ã«ç§»è¡Œã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
Cloud SQL ã«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã™ã‚‹å ´åˆã€ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ `.bak` ã¨ `ãƒ—ãƒ¬ãƒ¼ãƒ³ SQL` ãŒåˆ©ç”¨ã§ãã¾ã—ãŸãŒã€ä»Šå› Cloud SQL ã«ç§»è¡Œã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¯ç…§åˆé †åºã‚’å¤‰æ›´ã—ãŸã‹ã£ãŸãŸã‚ã€bacpac ã§ç§»è¡Œã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚

è©°ã¾ã£ãŸç‚¹ã«ã¤ã„ã¦å…ˆã«ã„ã†ã¨ã€éåŒ…å«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ã¯ bacpac ã§ã®ç§»è¡Œæ™‚ã« sa ã‚„ dbo ãªã©ã‚·ã‚¹ãƒ†ãƒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä»¥å¤–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¾©å…ƒã®éš›ã«ã©ã†ã—ã¦ã‚‚ã‚¨ãƒ©ãƒ¼ãŒã§ã¦ã—ã¾ã„ã¾ã™ã€‚
ãã®ãŸã‚ã€ä¸€èˆ¬ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯äº‹å‰ã«å‰Šé™¤ã—ã¦ãŠãã“ã¨ãŒãŠã™ã™ã‚ã§ã™ã€‚
![user delete](/images/2023-08-10-01.png)

#### SqlPackage ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
`bacpac` ã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã€[SqlPackage](https://learn.microsoft.com/ja-jp/sql/tools/sqlpackage/sqlpackage-download) ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

#### ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
ç§»è¡Œæ•´ç†ç”¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‹ã‚‰ Cloud SQL ç”¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚
SSMS ã‹ã‚‰ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ã«`ãƒ‡ãƒ¼ã‚¿å±¤ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ`ã‚’è¡Œã†æ–¹æ³•ã‚‚ã‚ã‚Šã¾ã™ãŒã€å½“ç¤¾ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¯æ•´ç†ãŒè¡Œãå±Šã„ã¦ãŠã‚‰ãšã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä¾å­˜æ€§æ¤œè¨¼ã«å¤±æ•—ã—ã¾ã™ã€‚
ãã®ãŸã‚ã‚³ãƒãƒ³ãƒ‰ã‹ã‚‰ä¾å­˜æ€§æ¤œè¨¼ã‚’ç„¡åŠ¹ã«ã™ã‚‹ã‚ªãƒ—ã‚·ãƒ§ãƒ³ `VerifyExtraction=False` ã‚’ä»˜ã‘ã¦ bacpac å‡ºåŠ›ã‚’å®Ÿæ–½ã—ã¾ã—ãŸã€‚(ãã‚‚ãã‚‚ä¾å­˜æ€§è§£æ±ºã—ã‚ã£ã¦è©±ã§ã™ãŒâ€¦)
ãªãŠã€ã„ãã¤ã‹ã®ä¾å­˜é–¢ä¿‚ã¯è§£æ¶ˆã—ã¦ãŠã‹ãªã„ã¨ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ™‚ã®ã‚¹ã‚­ãƒ¼ãƒæ§‹ç¯‰ã§å¤±æ•—ã—ãŸã®ã§ã€ç§»è¡Œæ¤œè¨¼ã§å¼•ã£ã‹ã‹ã£ãŸã‚‚ã®ã®ã¿äº‹å‰ã«è§£æ±ºã—ã¦ãŠãã¾ã—ãŸã€‚
```powershell:powershell
> SqlPackage /a:Export /ssn:server-name /sdn:database-name /tf:"cloud-sql.bacpac" /sec:True /stsc:True /su:sa /sp:sa-password /DiagnosticsFile:"bacpac_export.log" /p:VerifyExtraction=False
...
Successfully exported database and saved it to file 'C:\Users\Administrator\Desktop\cloud-sql.bacpac'.
Changes to connection setting default values were incorporated in a recent release.  More information is available at https://aka.ms/dacfx-connection
Time elapsed 0:18:25.29
```

ãªãŠã€ä¾å­˜æ€§ã®ç¢ºèªã«ã¯æ¬¡ã®ã‚¯ã‚¨ãƒªã‚’ç”¨ã„ã¾ã—ãŸã€‚
```sql:sql
with cte
as (
    select   sed.referencing_id
            ,obj_name = coalesce(sed.referenced_schema_name + '.', '') + sed.referenced_entity_name
    from     sys.sql_expression_dependencies sed
    where    sed.is_ambiguous = 0 and sed.referenced_id is null
)
select   cte.referencing_id
        ,obj_name = quotename(schema_name(all_object.[schema_id])) + '.' + quotename(all_object.name)
        ,invalid_object_name = cte.obj_name
        ,all_object.type
from     cte
join sys.objects all_object on cte.referencing_id = all_object.object_id
```

#### mode.xml æ›´æ–°
bacpac ãŒå‡ºåŠ›ã•ã‚ŒãŸã‚‰ã€ç…§åˆé †åºã‚’å¤‰æ›´ã™ã‚‹ãŸã‚å†…å®¹ã‚’ç·¨é›†ã—ã¾ã™ã€‚
å‡ºåŠ›ã•ã‚ŒãŸ bacpac ã®å®Ÿæ…‹ã¯ zip ãƒ•ã‚¡ã‚¤ãƒ«ã§ã‚ã‚‹ãŸã‚ã€æ‹¡å¼µå­ã‚’ zip ã«ã—ã¦ã‚¨ã‚¯ã‚¹ãƒ—ãƒ­ãƒ¼ãƒ©ã§ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’é–‹ãã€ãƒ«ãƒ¼ãƒˆã«ã‚ã‚‹ `model.xml` ã«è¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ç…§åˆé †åºã‚’ä»Šå›å¤‰æ›´ã—ãŸã„ç…§åˆé †åºã«å¤‰æ›´ã—ã¾ã™ã€‚
```diff:model.xml
 <?xml version="1.0" encoding="utf-8"?>
 <DataSchemaModel FileFormatVersion="1.2" SchemaVersion="3.5" DspName="Microsoft.Data.Tools.Schema.Sql.Sql160DatabaseSchemaProvider" CollationLcid="1041" CollationCaseSensitive="True" xmlns="http://schemas.microsoft.com/sqlserver/dac/Serialization/2012/02">
    <Model>
        <Element Type="SqlDatabaseOptions" Disambiguator="1">
-             <Property Name="Collation" Value="Japanese_XJIS_100_BIN2" />
+             <Property Name="Collation" Value="Japanese_XJIS_140_CI_AS_UTF8" />
```

#### Origin.xml æ›´æ–°
`mode.xml` ã‚’å¤‰æ›´ã—ãŸã‚‰ã€åŒã˜ããƒ«ãƒ¼ãƒˆã«ã‚ã‚‹ `Origin.xml` ã« `mode.xml` ã®ãƒãƒƒã‚·ãƒ¥å€¤ãŒè¨˜è¼‰ã•ã‚Œã¦ã„ã‚‹ã®ã§æ›´æ–°ã—ã¾ã™ã€‚

###### ãƒãƒƒã‚·ãƒ¥å€¤ã‚’å‡ºåŠ›
```powershell:powershell
> CertUtil -hashfile "model.xml" SHA256
SHA256 ãƒãƒƒã‚·ãƒ¥ (å¯¾è±¡ model.xml):
89164e42eb1161093c3df7776db3bdbeed4285fe1e7563c46d27c8ca8ed7cb59
CertUtil: -hashfile ã‚³ãƒãƒ³ãƒ‰ã¯æ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸã€‚
```

###### Origin.xml æ›´æ–°
```diff:model.xml
  <Checksums>
-    <Checksum Uri="/model.xml">7B86470B421B10506E52B33EC3B025B04899E83240A6CC98CE2D5502D4103E6E</Checksum>
+    <Checksum Uri="/model.xml">89164e42eb1161093c3df7776db3bdbeed4285fe1e7563c46d27c8ca8ed7cb59</Checksum>
  </Checksums>
```

#### å†ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–
ä¿®æ­£ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã«ä¸Šæ›¸ãè¿½åŠ ã™ã‚‹ã¨ bacpac å‡ºåŠ›ã®éš›ã« `Zip ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã«ã¯ã€ã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„ãƒ‡ãƒ¼ã‚¿æ§‹é€ ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ã€‚` ã¨æ€’ã‚‰ã‚Œã¾ã™ã®ã§ã€ä¸€åº¦å…¨è§£å‡ã—ã¦ã‹ã‚‰å†ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã—ã¦ãŠãã¾ã™ã€‚æ™‚é–“ãŒã‹ã‹ã‚‹ã®ã§ãŠèŒ¶ã§ã‚‚ã—ã¾ã—ã‚‡ã†ğŸµ


#### ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
bacpac ã®ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãŒçµ‚ãˆãŸã‚‰ã€å¯¾è±¡ã‚µãƒ¼ãƒã«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™ã€‚
```powershell:powershell
> SqlPackage /a:Import /tsn:cloud-sql-server /tdn:database-name /sf:"cloud-sql.bacpac" /tec:True /ttsc:True /tu:sqlserver /tp:sqlserver-password /DiagnosticsFile:"bacpac_import.log"
```

:::message
éåŒ…å«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ç§»è¡Œã§ã¯ã€å¾©å…ƒãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã® SQL ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¾©å…ƒã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«å­˜åœ¨ã™ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ãªã‘ã‚Œã°æ¬¡ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒå‡ºã¾ã™ã€‚
```
*** Error importing database:Could not import package.
Error SQL0: The element [username] cannot be deployed. This element contains state that cannot be recreated in the target database.
```
ã“ã‚Œã‚’è§£æ¶ˆã™ã‚‹ãŸã‚ã«ã€äº‹å‰ã« SQL ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã™ã‚‹ãªã©è©¦ã—ã¾ã—ãŸãŒãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ç´ã¥ã‘ãŒå‡ºæ¥ã¦ã„ãªã„ãŸã‚ã‹ã‚¨ãƒ©ãƒ¼ã‚’è§£æ¶ˆã™ã‚‹ã“ã¨ãŒã§ããªãã€ã‹ã¤ãƒ¦ãƒ¼ã‚¶ãƒ¼æ•°ã‚‚å°‘æ•°ã§ã‚ã£ãŸãŸã‚ã€bacpac ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå‰ã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å‰Šé™¤ã—ã¦ã€ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¾Œã«æ–°ãŸã«ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½œæˆã™ã‚‹æ–¹æ³•ã§ã™ã™ã‚ã¾ã—ãŸã€‚
:::


#### ç…§åˆé †åºå¤‰æ›´æ™‚ã®æ³¨æ„ç‚¹
ä»Šå›ã¯ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ç…§åˆé †åºã‚’ UTF8 ã«å¤‰æ›´ã—ãŸãŸã‚ã€bacpac ã‚¤ãƒ³ãƒãƒ¼ãƒˆã®éš›ã« varchar ã®ã‚«ãƒ©ãƒ ã‚µã‚¤ã‚ºãŒã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã™ã‚‹ã‚¨ãƒ©ãƒ¼ã«è¦‹èˆã‚ã‚Œã¾ã—ãŸã€‚
```:error message
```

å¼Šç¤¾ã®ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã§ã¯ã€åŸºæœ¬çš„ã«æ–‡å­—åˆ—å‹ã« nchar ã€å¯å¤‰æ–‡å­—åˆ—å‹ã« nvarchar ã‚’æ¡ç”¨ã—ã¦ã„ã¾ã™ãŒã€ç®¡ç†ãŒãªã•ã‚Œã¦ã„ãªã„ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã¤ã„ã¦ã¯ cahr å‹ã‚„ varchar å‹ãŒæ®‹ã£ã¦ã„ã¾ã—ãŸã€‚
ã“ã‚Œã‚’è§£æ¶ˆã™ã‚‹ãŸã‚ã«ã€ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå‰ã«æ¬¡ã®ã‚¯ã‚¨ãƒªã§æ–‡å­—åˆ—å‹ã‚’ nchar, nvarchar ã«å¤‰æ›ã™ã‚‹ã“ã¨ã¨ã—ã¾ã—ãŸã€‚
```sql:TSQL
declare @sql as varchar(max) = '';

declare cur cursor for
select   'alter table [' + t.TABLE_SCHEMA + '].[' + t.TABLE_NAME + '] '
        +'alter column [' + t.COLUMN_NAME + '] '
        +'nvarchar(' + case when t.CHARACTER_MAXIMUM_LENGTH=-1 then 'max' else cast(t.CHARACTER_MAXIMUM_LENGTH as varchar) end + ') '
        +case when t.COLLATION_NAME is null then '' else 'collate ' + t.COLLATION_NAME + ' ' end
        +case when t.IS_NULLABLE='YES' then 'null ' else '' end
        +';' + char(10)

        +case when t.COLUMN_DEFAULT is null then ''
              else 'alter table [' + t.TABLE_SCHEMA + '].[' + t.TABLE_NAME + '] '
                  +'add default ' + t.COLUMN_DEFAULT + ' '
                  +'for ' + t.COLUMN_NAME + ' '
                  +';' + char(10)
         end
from     INFORMATION_SCHEMA.COLUMNS t
left outer join INFORMATION_SCHEMA.VIEWS b
    on b.TABLE_CATALOG = t.TABLE_CATALOG and b.TABLE_SCHEMA = t.TABLE_SCHEMA and b.TABLE_NAME = t.TABLE_NAME
where    t.DATA_TYPE in('varchar')
  and    t.COLLATION_NAME = 'Japanese_XJIS_100_BIN2'
--  and    t.TABLE_SCHEMA in('dbo')
  and    b.TABLE_NAME is null
;
open cur;
fetch next from cur into @sql;
while @@FETCH_STATUS=0
begin
    --print @sql
    exec(@sql)
    fetch next from cur into @sql;
end
close cur;
deallocate cur;
```

#### Cloud SQL ã®ãƒªãƒ³ã‚¯ã‚µãƒ¼ãƒè¨­å®š
Cloud SQL ã®ãƒªãƒ³ã‚¯ã‚µãƒ¼ãƒè¨­å®šãŒã‚¹ãƒ ãƒ¼ã‚ºã«è¡Œãˆã¾ã›ã‚“ã§ã—ãŸã€‚
ã“ã¡ã‚‰ã¯åˆ¥é€”è¨˜äº‹ã«ã—ã¾ã™ã€‚


# ã‚ã¨ãŒã



# ã”å‚è€ƒãƒ»è¬è¾
https://qiita.com/qyen/items/4ff7d2fe5ed76d71637d
