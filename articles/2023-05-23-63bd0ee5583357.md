---
title: "Ubuntu ã§ Windows Active Directory ãƒ‰ãƒ¡ã‚¤ãƒ³ã«å‚åŠ ã—ã€å…±æœ‰ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹"
emoji: "ğŸˆ"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: [Ubuntu, Windows, ActiveDirectory]
published: true
---

å½“ç¤¾ã§ã¯ç¤¾å†…ãƒ‡ãƒ¼ã‚¿ã®åé›†ã®ãŸã‚ã€ãƒ‡ãƒ¼ã‚¿åé›†ã‚·ã‚¹ãƒ†ãƒ ã‚’ Ubuntu Server + Docker + Python ç’°å¢ƒã§æ§‹ç¯‰ã—ã¦ã„ã¾ã™ã€‚
ç¤¾å†…ã«ã¯å„æ‰€ã§æ§˜ã€…ãªæ¥­å‹™ãƒ•ã‚¡ã‚¤ãƒ«ãŒç‚¹åœ¨ã—ã¦ãŠã‚Šã€ãã‚Œã‚‰æ¥­å‹™ãƒ•ã‚¡ã‚¤ãƒ«ã®æƒ…å ±ã‚’æ­£è¦åŒ–ã—ã¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«é›†ç´„ã™ã‚‹ãƒ—ãƒ­ã‚·ãƒ¼ã‚¸ãƒ£ã§ã™ãŒã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ç’°å¢ƒã¯ Windows Active Directory ã®ãŸã‚ã€Ubuntu ã‹ã‚‰ ActiveDirectory ä¸Šã®å…±æœ‰ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã“ã§ã¯ã€å½“ç¤¾ãŒè¡Œã£ã¦ã„ã‚‹ Ubuntu Server ã‚’ Active Directory ã«å‚åŠ ã•ã›ã€å…±æœ‰ãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹è¨­å®šã«ã¤ã„ã¦å…±æœ‰ã—ã¦ã„ãã¾ã™ã€‚
ã•ã‚‰ã«ã‚·ãƒ³ãƒ—ãƒ«ãªè¨­å®šæ–¹æ³•ãŒã‚ã‚Œã°ã€ãœã²ã‚³ãƒ¡ãƒ³ãƒˆãã ã•ã„ï¼

# å‰æ & ç’°å¢ƒ
Ubuntu Server ã¯ Docker ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿ã§ã‚µãƒ¼ãƒåã¯ `srv-ubuntu` IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ `192.168.1.10` ã€ç®¡ç†è€…ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ `hoge` ã¨ã—ã¦ã„ã¾ã™ã€‚
```sh:Ubuntu Server bash
$ lsb_release -a
No LSB modules are available.
Distributor ID: Ubuntu
Description:    Ubuntu 22.04.2 LTS
Release:        22.04
Codename:       jammy
```
ã¾ãŸã€Active Directory ãƒ‰ãƒ¡ã‚¤ãƒ³ã¯ `domain-name.co.jp` ã¨ã—ã€Active Directory ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒã¯ `dc.domain-name.co.jp` ã€IP ã¯ `192.168.1.2` ã¨ã—ã¾ã™ã€‚

# Active Directory ãƒ‰ãƒ¡ã‚¤ãƒ³ã«å‚åŠ 
Ubuntu Server ã‚’ Active Directory ã«å‚åŠ ã•ã›ã¾ã™ã€‚

### ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚

```sh:Ubuntu Server bash
$ sudo apt -y install realmd krb5-user sssd sssd-tools libnss-sss libpam-sss adcli adsys samba-common-bin oddjob oddjob-mkhomedir packagekit
```

ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«é€”ä¸­ã§ãƒ‰ãƒ¡ã‚¤ãƒ³ã®å…¥åŠ›ã‚’æ±‚ã‚ã‚‰ã‚Œã‚‹ã®ã§ã€å¤§æ–‡å­—ã§å…¥åŠ›ã—ã¾ã™ã€‚
```sh:Ubuntu Server bash
Setting up krb5-config (2.6+nmu1ubuntu1) ...
debconf: unable to initialize frontend: Dialog
debconf: (No usable dialog-like program is installed, so the dialog based frontend cannot be used. at /usr/share/perl5/Debconf/FrontEnd/Dialog.pm line 78.)
debconf: falling back to frontend: Readline
Configuring Kerberos Authentication
-----------------------------------

When users attempt to use Kerberos and specify a principal or user name without specifying what
administrative Kerberos realm that principal belongs to, the system appends the default realm.  The default
realm may also be used as the realm of a Kerberos service running on the local machine.  Often, the default
realm is the uppercase version of the local DNS domain.

Default Kerberos version 5 realm: DOAMIN-NAME.CO.JP  # â† å¤§æ–‡å­—ã§å…¥åŠ›
```


### å‚ç…§ DNS ã« AD ã‚µãƒ¼ãƒã‚’æŒ‡å®šã™ã‚‹
Netplan ã®æ—¢å­˜è¨­å®šãƒ•ã‚¡ã‚¤ãƒ« `/etc/netplan/00-installer-config.yaml` ã‚’é–‹ãã€å‚ç…§ DNS ã« Active Directory ã‚µãƒ¼ãƒãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚
```sh:Ubuntu Server bash
$ sudo vi /etc/netplan/00-installer-config.yaml
network:
  ethernets:
    eth0:
      addresses:
      - 192.168.1.10/24
      nameservers:
        addresses:
        - 192.168.1.2  # â† DNS ã‚µãƒ¼ãƒ (Active Direcotry ã‚µãƒ¼ãƒ) ã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèª
        search: []
      routes:
      - to: default
        via: 192.168.1.1
  version: 2
```

Active Directory ã‚µãƒ¼ãƒãŒè¨­å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã® IP ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’æ›¸ãæ›ãˆã¦ã€å¤‰æ›´ã‚’é©ç”¨ã—ã¾ã™ã€‚
```sh:Ubuntu Server bash
$ sudo netplan apply  # Netplan ã®å¤‰æ›´ã‚’é©ç”¨
```

### å‚ç…§ NTP ã« AD ã‚µãƒ¼ãƒã‚’æŒ‡å®šã™ã‚‹
NTP ã‚µãƒ¼ãƒã« Active Directory ã‚µãƒ¼ãƒã‚’æŒ‡å®šã—ã¾ã™ã€‚

##### `/etc/systemd/timesyncd.conf` ãƒ•ã‚¡ã‚¤ãƒ«ã« NTP è¨­å®šã‚’è¿½åŠ ã—ã¾ã™ã€‚
```diff:Ubuntu Server bash
$ sudo vi /etc/systemd/timesyncd.conf
+[Time]
+NTP=dc.domain-name.co.jp
```

##### è¨­å®šã‚’é©ç”¨ã—ã¾ã™ã€‚
```sh:Ubuntu Server bash
$ sudo systemctl restart systemd-timesyncd
$ sudo timedatectl timesync-status
       Server: 192.168.1.2 (dc.domain-name.co.jp)
Poll interval: 1min 4s (min: 32s; max 34min 8s)
         Leap: normal
      Version: 3
      Stratum: 2
    Reference: 92F8DEB4
    Precision: 15.625ms (-6)
Root distance: 60.531ms (max: 5s)
       Offset: +22.387ms
        Delay: 290us
       Jitter: 0
 Packet count: 1
    Frequency: +190.560ppm
```

##### ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’ `Asia/Tokyo` ã«ã—ã¦ãŠãã¾ã™ (å¿…é ˆã§ã¯ãªã„)
```sh:Ubuntu Server bash
$ sudo timedatectl set-timezone Asia/Tokyo
$ timedatectl
               Local time: Fri 2023-06-23 08:15:17 JST
           Universal time: Thu 2023-06-22 23:15:17 UTC
                 RTC time: Thu 2023-06-22 23:15:17
                Time zone: Asia/Tokyo (JST, +0900)
System clock synchronized: yes
              NTP service: active
          RTC in local TZ: no
```

### ãƒ›ã‚¹ãƒˆåå¤‰æ›´
äº‹å‰ã«ãƒ›ã‚¹ãƒˆåã‚’ FQDN ã«å¤‰æ›´ã—ã¦ãŠãã¾ã™ã€‚
```sh:Ubuntu Server bash
$ sudo hostname srv-ubuntu.domain-name.co.jp
```

### Active Dicrctory ãƒ‰ãƒ¡ã‚¤ãƒ³ã®æ¤œç´¢
å‚åŠ ã™ã‚‹ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’æ¤œç´¢ã—ã¾ã™ã€‚
```sh:Ubuntu Server bash
$ realm discover domain-name.co.jp
domain-name.co.jp
  type: kerberos
  realm-name: domain-name.CO.JP
  domain-name: domain-name.co.jp
  configured: no
  server-software: active-directory
  client-software: sssd
  required-package: sssd-tools
  required-package: sssd
  required-package: libnss-sss
  required-package: libpam-sss
  required-package: adcli
  required-package: samba-common-bin
```

### Active Directory ã«å‚åŠ 
ç®¡ç†è€…ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’ç”¨ã„ã¦ Active Directory ã«å‚åŠ ã—ã¾ã™ã€‚
Active Directory ç®¡ç†ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯æŒ‡å®šã—ãªãã¦ã‚‚é€²ã¿ã¾ã™ãŒã€çµŒé¨“ä¸Šã“ã“ã§æŒ‡å®šã—ã¦ãŠã„ãŸæ–¹ãŒå¾Œã€…ã®ãƒˆãƒ©ãƒ–ãƒ«ãŒå°‘ãªããªã‚Šã¾ã™ã€‚
ãªãŠã€Active Directory ç®¡ç†ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‰ãƒ¡ã‚¤ãƒ³åã¯å¤§æ–‡å­—ã§è¨˜è¼‰ã—ã¾ã™ã€‚(ãƒ¬ãƒ«ãƒ ã¯å…¨ã¦å¤§æ–‡å­—)

##### Active Directory ã«å‚åŠ 
```sh:Ubuntu Server bash
$ sudo realm join -U Administrator@DOMAIN-NAME.CO.JP domain-name.co.jp -v
 * Resolving: _ldap._tcp.domain-name.co.jp
 * Performing LDAP DSE lookup on: 192.168.10.2
 * Successfully discovered: domain-name.co.jp
Password for Administrator@DOMAIN-NAME.CO.JP:
 * Unconditionally checking packages
 * Resolving required packages
 * LANG=C /usr/sbin/adcli join --verbose --domain domain-name.co.jp --domain-realm DOMAIN-NAME.CO.JP --domain-controller 192.168.10.2 --login-type user --login-user Administrator@DOMAIN-NAME.CO.JP --stdin-password
 * Using domain name: domain-name.co.jp
 * Calculated computer account name from fqdn: SRV-UBUNTU
 * Using domain realm: domain-name.co.jp
 * Sending NetLogon ping to domain controller: 192.168.10.2
 * Received NetLogon info from: DC.domain-name.co.jp
 * Wrote out krb5.conf snippet to /var/cache/realmd/adcli-krb5-lnLOdl/krb5.d/adcli-krb5-conf-FVu2Bo
 * Authenticated as user: Administrator@DOMAIN-NAME.CO.JP
 * Using GSS-SPNEGO for SASL bind
 * Looked up short domain name: DOMAIN-NAME
 * Looked up domain SID: S-8-8-88-8888888888-8888888888-8888888888
 * Using fully qualified name: srv-ubuntu.domain-name.co.jp
 * Using domain name: domain-name.co.jp
 * Using computer account name: SRV-UBUNTU
 * Using domain realm: domain-name.co.jp
 * Calculated computer account name from fqdn: SRV-UBUNTU
 * Generated 120 character computer password
 * Using keytab: FILE:/etc/krb5.keytab
 * A computer account for SRV-UBUNTU$ does not exist
 * Found well known computer container at: CN=Computers,DC=domain-name,DC=co,DC=jp
 * Calculated computer account: CN=SRV-UBUNTU,CN=Computers,DC=domain-name,DC=co,DC=jp
 * Encryption type [3] not permitted.
 * Encryption type [1] not permitted.
 * Created computer account: CN=SRV-UBUNTU,CN=Computers,DC=domain-name,DC=co,DC=jp
 * Sending NetLogon ping to domain controller: 192.168.10.2
 * Received NetLogon info from: DC.domain-name.co.jp
 * Set computer password
 * Retrieved kvno '2' for computer account in directory: CN=SRV-UBUNTU,CN=Computers,DC=domain-name,DC=co,DC=jp
 * Checking RestrictedKrbHost/srv-ubuntu.domain-name.co.jp
 *    Added RestrictedKrbHost/srv-ubuntu.domain-name.co.jp
 * Checking RestrictedKrbHost/SRV-UBUNTU
 *    Added RestrictedKrbHost/SRV-UBUNTU
 * Checking host/srv-ubuntu.domain-name.co.jp
 *    Added host/srv-ubuntu.domain-name.co.jp
 * Checking host/SRV-UBUNTU
 *    Added host/SRV-UBUNTU
 ! Couldn't authenticate with keytab while discovering which salt to use: SRV-UBUNTU$@DOMAIN-NAME.CO.JP: Client 'SRV-UBUNTU$@DOMAIN-NAME.CO.JP' not found in Kerberos database
 * Added the entries to the keytab: SRV-UBUNTU$@DOMAIN-NAME.CO.JP: FILE:/etc/krb5.keytab
 * Added the entries to the keytab: host/SRV-UBUNTU@DOMAIN-NAME.CO.JP: FILE:/etc/krb5.keytab
 * Added the entries to the keytab: host/srv-ubuntu.domain-name.co.jp@DOMAIN-NAME.CO.JP: FILE:/etc/krb5.keytab
 * Added the entries to the keytab: RestrictedKrbHost/SRV-UBUNTU@DOMAIN-NAME.CO.JP: FILE:/etc/krb5.keytab
 * Added the entries to the keytab: RestrictedKrbHost/srv-ubuntu.domain-name.co.jp@DOMAIN-NAME.CO.JP: FILE:/etc/krb5.keytab
 ! Failed to update Kerberos configuration, not fatal, please check manually: Setting attribute standard::type not supported
 * /usr/sbin/update-rc.d sssd enable
 * /usr/sbin/service sssd restart
 * Successfully enrolled machine in realm
```

ã“ã“ã§ã¯æ¬¡ã®ã‚ˆã†ãªã‚¨ãƒ©ãƒ¼ãŒå‡ºã¾ã—ãŸã€‚
```
 ! Couldn't authenticate with keytab while discovering which salt to use: SRV-UBUNTU$@DOMAIN-NAME.CO.JP: Client 'SRV-UBUNTU$@DOMAIN-NAME.CO.JP' not found in Kerberos database
 ! Failed to update Kerberos configuration, not fatal, please check manually: Setting attribute standard::type not supported
```
Active Directory ã®æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã§ã¯èªè¨¼æ–¹å¼ã®å•é¡Œã§åˆå›ã®è¨­å®šã¯ä¸­é€”åŠç«¯ã«æˆåŠŸã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã‚’ã—ã£ã‹ã‚Šè¡Œã£ã¦ã„ã‚‹æ„è­˜é«˜ã„ç³»ã»ã©ã€ç½ ã«ãƒãƒã‚Šã‚„ã™ã„æ°—ãŒã—ã¾ã™ãƒ»ãƒ»ç’°å¢ƒã«ã‚ˆã£ã¦ã¯å•é¡Œãªãé€²ã‚€ã“ã¨ã‚‚ã‚ã‚Šã€ãã®éƒ½åº¦åˆ¤æ–­ã—ã¾ã—ã‚‡ã†ã€‚

- `! Failed to update Kerberos configuration, not fatal, please check manually: Setting attribute standard::type not supported`
ã“ã®ã‚¨ãƒ©ãƒ¼ã¯å¾Œã§ `/etc/krb5.conf` ã‚’ä¿®æ­£ã™ã‚‹ã®ã§æ”¾ã£ã¦ãŠãã¾ã—ã‚‡ã†ã€‚

- `! Couldn't authenticate with keytab while discovering which salt to use: SRV-UBUNTU$@DOMAIN-NAME.CO.JP: Client 'SRV-UBUNTU$@DOMAIN-NAME.CO.JP' not found in Kerberos database`
ã“ã®ã‚¨ãƒ©ãƒ¼ãŒå‡ºãŸå ´åˆã¯ã€Kerberos èªè¨¼ã«å•é¡ŒãŒèµ·ãã¦ã„ã¾ã™ã®ã§ã€ä»¥ä¸‹ã®æ“ä½œã§å†åº¦ãƒ‰ãƒ¡ã‚¤ãƒ³èªè¨¼ã‚’è¡Œã„ã¾ã™ã€‚

:::message
Kerberos èªè¨¼ã«å•é¡ŒãŒèµ·ãã¦ã„ã‚‹å ´åˆã¯ã€æ¬¡ã®æ‰‹é †ã§å†åº¦èªè¨¼ã‚’è¡Œã„ã¾ã™ã€‚

##### Windows Active Directory ã‚¨ãƒ³ãƒˆãƒªã®è¨­å®šå¤‰æ›´
Windows ã‚µãƒ¼ãƒå´ã§ Active Directory ã«ç™»éŒ²ã•ã‚ŒãŸ srv-ubuntu ã‚³ãƒ³ãƒ”ãƒ¥ãƒ¼ã‚¿ã®å±æ€§ã‚¨ãƒ³ãƒˆãƒª (ms-DS-Supported-Encryption-Types) ã‚’å¤‰æ›´ã—ã¾ã™ã€‚
ã“ã“ã§ã¯ã€`28 (RC4, AES 128, AES 256)` ã‹ã‚‰ `16 (AES 256)` ã«å¤‰æ›´
![ms-DS-Supported-Encryption-Types](/images/2023-05-23-01.png)

#####  Active Directory ã«å‚åŠ  (ãƒªãƒˆãƒ©ã‚¤)
Active Dicretory ã‹ã‚‰é›¢è„±ã—ã¾ã™ã€‚
```sh:Ubuntu Server bash
$ sudo realm leave  # ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’æŠœã‘ã‚‹
```
SSSD ã‚µãƒ¼ãƒ“ã‚¹ã‚’åœæ­¢
```sh:Ubuntu Server bash
$ sudo systemctl disable sssd
$ sudo systemctl stop sssd
```
Kerberos ã‚­ãƒ¼ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã€SSSD ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤
```sh:Ubuntu Server bash
$ sudo rm /etc/krb5.keytab
$ sudo chmod -R 666 /var/lib/sss/db
$ sudo rm -rf /tmp/krb5-*
$ sudo rm -rf /tmp/adcli-krb5-*
$ sudo rm -rf /var/adcli-krb5-*
$ sudo rm -rf /var/lib/sss/db/*
$ sudo rm -rf /var/lib/sss/secrets/*
$ sudo chmod 600 /var/lib/sss/db
```
SSSD ã‚µãƒ¼ãƒ“ã‚¹ã‚’å†é–‹ (relmd ã«ã‚ˆã£ã¦æœ‰åŠ¹åŒ–ã•ã‚Œã‚‹ã®ã§ä¸è¦ã ãŒã€å¿µã®ãŸã‚)
```sh:Ubuntu Server bash
$ sudo systemctl enable sssd
```
Active Directory ã«å†ã³å‚åŠ ã—ã¾ã™ã€‚
```sh:Ubuntu Server bash
$ sudo realm join -U Administrator@DOMAIN-NAME.CO.JP domain-name.co.jp -v
 * Resolving: _ldap._tcp.domain-name.co.jp
 * Performing LDAP DSE lookup on: 192.168.10.2
 * Successfully discovered: domain-name.co.jp
Password for Administrator@DOMAIN-NAME.CO.JP:
 * Unconditionally checking packages
 * Resolving required packages
 * LANG=C /usr/sbin/adcli join --verbose --domain domain-name.co.jp --domain-realm DOMAIN-NAME.CO.JP --domain-controller 192.168.10.2 --login-type user --login-user Administrator@DOMAIN-NAME.CO.JP --stdin-password
 * Using domain name: domain-name.co.jp
 * Calculated computer account name from fqdn: SRV-UBUNTU
 * Using domain realm: domain-name.co.jp
 * Sending NetLogon ping to domain controller: 192.168.10.2
 * Received NetLogon info from: DC.domain-name.co.jp
 * Wrote out krb5.conf snippet to /var/cache/realmd/adcli-krb5-1KArUu/krb5.d/adcli-krb5-conf-zu8xAe
 * Authenticated as user: Administrator@DOMAIN-NAME.CO.JP
 * Using GSS-SPNEGO for SASL bind
 * Looked up short domain name: DOMAIN-NAME
 * Looked up domain SID: S-8-8-88-8888888888-8888888888-8888888888
 * Using fully qualified name: srv-ubuntu.domain-name.co.jp
 * Using domain name: domain-name.co.jp
 * Using computer account name: SRV-UBUNTU
 * Using domain realm: domain-name.co.jp
 * Calculated computer account name from fqdn: SRV-UBUNTU
 * Generated 120 character computer password
 * Using keytab: FILE:/etc/krb5.keytab
 * Found computer account for SRV-UBUNTU$ at: CN=SRV-UBUNTU,CN=Computers,DC=domain-name,DC=co,DC=jp
 * Sending NetLogon ping to domain controller: 192.168.10.2
 * Received NetLogon info from: DC.domain-name.co.jp
 * Set computer password
 * Retrieved kvno '3' for computer account in directory: CN=SRV-UBUNTU,CN=Computers,DC=domain-name,DC=co,DC=jp
 * Checking RestrictedKrbHost/srv-ubuntu.domain-name.co.jp
 *    Added RestrictedKrbHost/srv-ubuntu.domain-name.co.jp
 * Checking RestrictedKrbHost/SRV-UBUNTU
 *    Added RestrictedKrbHost/SRV-UBUNTU
 * Checking host/srv-ubuntu.domain-name.co.jp
 *    Added host/srv-ubuntu.domain-name.co.jp
 * Checking host/SRV-UBUNTU
 *    Added host/SRV-UBUNTU
 * Discovered which keytab salt to use
 * Added the entries to the keytab: SRV-UBUNTU$@DOMAIN-NAME.CO.JP: FILE:/etc/krb5.keytab
 * Added the entries to the keytab: host/SRV-UBUNTU@DOMAIN-NAME.CO.JP: FILE:/etc/krb5.keytab
 * Added the entries to the keytab: host/srv-ubuntu.domain-name.co.jp@DOMAIN-NAME.CO.JP: FILE:/etc/krb5.keytab
 * Added the entries to the keytab: RestrictedKrbHost/SRV-UBUNTU@DOMAIN-NAME.CO.JP: FILE:/etc/krb5.keytab
 * Added the entries to the keytab: RestrictedKrbHost/srv-ubuntu.domain-name.co.jp@DOMAIN-NAME.CO.JP: FILE:/etc/krb5.keytab
 * /usr/sbin/update-rc.d sssd enable
 * /usr/sbin/service sssd restart
 * Successfully enrolled machine in realm
```
:::

Active Directory ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æƒ…å ±ã‚’å–å¾—ã§ãã‚Œã°èªè¨¼ã¯å®Œäº†ã§ã™ã€‚
```sh:Ubuntu Server bash
$ id Administrator@DOMAIN-NAME.CO.JP
uid=199600500(administrator) gid=199600513(domain users) groups=199600513(domain users)...
```


### è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´
ç¶šã‘ã¦ã€ä½¿ã„ã‚„ã™ã„ã‚ˆã†ã«è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¤‰æ›´ã—ã¦ã„ãã¾ã™ã€‚

##### SSSD ã‚µãƒ¼ãƒ“ã‚¹ã®è¨­å®šå¤‰æ›´
```diff:/etc/sssd/sssd.conf
[sssd]
domains = domain-name.co.jp
config_file_version = 2
services = nss, pam

[domain/domain-name.co.jp]
default_shell = /bin/bash
krb5_store_password_if_offline = True
cache_credentials = True
krb5_realm = DMAIN_NAME.CO.JP
realmd_tags = manages-system joined-with-adcli
id_provider = ad
+fallback_homedir = /home/%u  # ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ•ã‚©ãƒ«ãƒ€åã‚’å¤‰æ›´
-fallback_homedir = /home/%u@%d
ad_domain = domain-name.co.jp
+use_fully_qualified_names = False  # Active Directory ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‰ãƒ¡ã‚¤ãƒ³åã‚’çœç•¥
-use_fully_qualified_names = True
ldap_id_mapping = True
access_provider = ad
```

##### Kerberos ã®è¨­å®šå¤‰æ›´
```diff:/etc/krb5.conf
[libdefaults]
udp_preference_limit = 0
default_realm = DOMAIN-NAME.CO.JP
+
+[logging]
+default = FILE:/var/log/krb5libs.log  # ãƒ­ã‚°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¨­å®š
+
+[domain_realm]
+.domain-name.co.jp = DOMAIN-NAME.CO.JP  # å°æ–‡å­—ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ãƒ¬ãƒ«ãƒ ã«ãƒãƒƒãƒ”ãƒ³ã‚°
+domain-name.co.jp = DOMAIN-NAME.CO.JP
```

##### PAM ã®è¨­å®š
```sh:Ubuntu Server bash
$ sudo pam-auth-update
PAM configuration
-----------------

Pluggable Authentication Modules (PAM) determine how authentication, authorization, and password changing
are handled on the system, as well as allowing configuration of additional actions to take when starting
user sessions.

Some PAM module packages provide profiles that can be used to automatically adjust the behavior of all
PAM-using applications on the system.  Please indicate which of these behaviors you wish to enable.

  1. Pwquality password strength checking  5. Register user sessions in the systemd control group hierarchy
  2. Unix authentication                   6. Create home directory on login
  3. SSS authentication                    7. Inheritable Capabilities Management
  4. ADSys authentication                  8. none of the above

(Enter the items or ranges you want to select, separated by spaces.)

PAM profiles to enable: 2 3 6  # â† ã“ã“ã§ã¯ 2, 3, 6 ã‚’é¸æŠ
```

##### SSSD ã‚µãƒ¼ãƒ“ã‚¹å†èµ·å‹•
```sh:Ubuntu Server bash
$ sudo systemctl restart sssd
$ sudo systemctl status sssd
â— sssd.service - System Security Services Daemon
     Loaded: loaded (/lib/systemd/system/sssd.service; enabled; vendor preset: enabled)
     Active: active (running) since Sat 2023-06-24 08:19:11 JST; 3s ago
   Main PID: 107390 (sssd)
      Tasks: 4 (limit: 154452)
     Memory: 45.8M
        CPU: 183ms
     CGroup: /system.slice/sssd.service
             â”œâ”€107390 /usr/sbin/sssd -i --logger=files
             â”œâ”€107391 /usr/libexec/sssd/sssd_be --domain domain-name.co.jp --uid 0 --gid 0 --logger=files
             â”œâ”€107392 /usr/libexec/sssd/sssd_nss --uid 0 --gid 0 --logger=files
             â””â”€107393 /usr/libexec/sssd/sssd_pam --uid 0 --gid 0 --logger=files

Jun 24 08:19:11 srv-ubuntu.domain-name.co.jp systemd[1]: Starting System Security Services Daemon...
Jun 24 08:19:11 srv-ubuntu.domain-name.co.jp sssd[107390]: Starting up
Jun 24 08:19:11 srv-ubuntu.domain-name.co.jp sssd_be[107391]: Starting up
Jun 24 08:19:11 srv-ubuntu.domain-name.co.jp sssd_nss[107392]: Starting up
Jun 24 08:19:11 srv-ubuntu.domain-name.co.jp sssd_pam[107393]: Starting up
Jun 24 08:19:11 srv-ubuntu.domain-name.co.jp systemd[1]: Started System Security Services Daemon.
```

### èªè¨¼ç¢ºèª
å¿µã®ãŸã‚èªè¨¼é–¢ä¿‚ã«å•é¡ŒãŒãªã„ã‹ç¢ºèªã—ã¦ãŠãã¾ã™ã€‚
```sh:Ubuntu Server bash
$ kinit Administrator
Password for Administrator@DOMAIN-NAME.CO.JP:
$ klist -e
Ticket cache: FILE:/tmp/krb5cc_1000
Default principal: Administrator@DOMAIN-NAME.CO.JP

Valid starting     Expires            Service principal
06/24/23 08:34:27  06/24/23 18:34:27  krbtgt/DOMAIN-NAME.CO.JP@DOMAIN-NAME.CO.JP
        renew until 06/25/23 08:34:23, Etype (skey, tkt): aes256-cts-hmac-sha1-96, aes256-cts-hmac-sha1-96
$ kdestroy
```

```sh:Ubuntu Server bash
$ id Administrator
uid=199600500(administrator) gid=199600513(domain users) groups=199600513(domain users)...
```

```sh:Ubuntu Server bash
$ getent passwd Administrator
administrator:*:1474800500:1474800585:Administrator:/home/administrator:/bin/bash
```

```sh:Ubuntu Server bash
$ groups Administrator
Administrator : domain users group policy creator owners enterprise admins domain admins schema admins ...
```

### Active Directory ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³
Active Directory ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¾ã™ã€‚
```sh:Ubuntu Server bash
$ sudo login
srv-ubuntu.domain-name.co.jp login: Administrator
Password:
Welcome to Ubuntu 22.04.2 LTS (GNU/Linux 5.15.0-72-generic x86_64)
...
Creating directory '/home/administrator'.
```

ç„¡äº‹ãƒ­ã‚°ã‚¤ãƒ³ã§ãã‚‹ã“ã¨ãŒç¢ºèªã§ããŸã‚‰ã€Active Directory ã®è¨­å®šã¯çµ‚äº†ã§ã™ã€‚
ã“ã‚Œã§ Active Directory ãƒ¦ãƒ¼ã‚¶ãƒ¼ã§ Kerberos èªè¨¼ã™ã‚‹æº–å‚™ãŒæ•´ã„ã¾ã—ãŸã€‚

### Windows Active Directory å…±æœ‰ãƒ•ã‚©ãƒ«ãƒ€ã®ãƒã‚¦ãƒ³ãƒˆ

å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¾ã™ã€‚
```sh:Ubuntu Server bash
$ sudo apt install cifs-utils
```
ãƒã‚¦ãƒ³ãƒˆãƒã‚¤ãƒ³ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚
```sh:Ubuntu Server bash
$ sudo mkdir -p /mnt/n
```

ä»Šå›ã¯å›ºå®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã§å…±æœ‰ãƒ•ã‚©ãƒ«ãƒ€ã‚’ãƒã‚¦ãƒ³ãƒˆã—ã¾ã™ã€‚
èªè¨¼ãƒ•ã‚¡ã‚¤ãƒ«ã« Active Directory ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¨­å®šã—ã¾ã™ã€‚
```/root/.credentials
username=
password=
domain=
```

èªè¨¼ãƒ•ã‚¡ã‚¤ãƒ«æ¨©é™ã‚’è¨­å®šã—ã¾ã™ã€‚
```sh:Ubuntu Server bash
$ sudo chmod 600 /root/.credentials
```

ãƒã‚¦ãƒ³ãƒˆã‚’æ°¸ç¶šåŒ–ã™ã‚‹ãŸã‚ã€`/etc/fstab` ã«ã‚¨ãƒ³ãƒˆãƒªã‚’ä½œæˆã—ã¾ã™ã€‚
```diff:/etc/fstab
+//file-server-name/share-dir /mnt/n cifs credentials=/root/.credentials,uid=0
```

ä»¥ä¸Šã®è¨­å®šã‚’è¡Œã„å†èµ·å‹•ã™ã‚‹ã¨ã€`/mnt/n` ã«å…±æœ‰ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒãƒã‚¦ãƒ³ãƒˆã•ã‚Œã¦ã„ã‚‹ã®ãŒç¢ºèªã§ãã¾ã™ã€‚
```sh:Ubuntu Server bash
$ ls /mnt/n
ShareDirectory1 ShareDirectory2 ShareDirectory3 ...
```

# ãŠã‚ã‚Š
ä»¥ä¸Šã§ã€Windows Active Dicretory ç’°å¢ƒã« Ubuntu Server ã‚’ãƒ‰ãƒ¡ã‚¤ãƒ³å‚åŠ ã•ã›ã¦ã€å…±æœ‰ãƒ•ã‚©ãƒ«ãƒ€ã¾ã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ç’°å¢ƒãŒæ•´ã„ã¾ã—ãŸã€‚
ãƒã‚¦ãƒ³ãƒˆãƒã‚¤ãƒ³ãƒˆã‚’ãƒã‚¤ãƒ³ãƒ‰ã™ã‚‹ã“ã¨ã§ Docker å†…ã‹ã‚‰ã‚‚å…±æœ‰ãƒ•ã‚©ãƒ«ãƒ€ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ãŸã‚ã€é‹ç”¨æ¡ä»¶ã®å¹…ã‚‚å¤§ããåºƒãŒã‚Šã¾ã™ã€‚
Kerberos èªè¨¼å‘¨ã‚Šã¯ãƒˆãƒ©ãƒ–ãƒ«ã‚‚å¤šã„ã§ã™ãŒã€èªè¨¼ã®ä»•çµ„ã¿ã‚’æŠŠæ¡ã™ã‚‹ã“ã¨ã§æ¯”è¼ƒçš„ç°¡å˜ã«è§£æ±ºã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã¨å…±ã«çŸ¥è­˜ã®å‘ä¸Šã«ç¹‹ãŒã‚‹ã¨æ€ã„ã¾ã™ã€‚
å®Ÿé‹ç”¨ã§ã¯ã“ã‚Œã‚‰ã‚’å¿œç”¨ã—ã¦ã„ãã“ã¨ã«ãªã‚Šã¾ã™ãŒã€ã“ã‚“ãªè¨­å®šè‰¯ã„ã‚ˆï¼ã¨ã„ã†ãŠè©±ãŒã‚ã‚Œã°ãœã²æ•™ãˆã¦ãã ã•ã„ï¼


# ã”å‚è€ƒãƒ»è¬è¾
https://techcommunity.microsoft.com/t5/core-infrastructure-and-security/decrypting-the-selection-of-supported-kerberos-encryption-types/ba-p/1628797
https://pkiwithadcs.com/details_about_kerberos_authentication/
https://devopstales.github.io/home/ubuntu-22.04-ad-join/
